<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizza Crossing</title>
    <style>
        @font-face {
            font-family: 'PressStart2P';
            src: url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        }
        
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            touch-action: none;
            color: #fff;
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 600px;
        }
        
        canvas {
            background-color: #0c093c;
            display: block;
            width: 100%;
            max-width: 600px;
            max-height: 100vh;
        }
        
        #gameInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #ff2a6d;
            font-size: 16px;
            z-index: 10;
            font-weight: bold;
            text-shadow: 2px 2px 0px #341677, 
                         -2px -2px 0px #341677, 
                         2px -2px 0px #341677, 
                         -2px 2px 0px #341677,
                         0px 0px 8px #05d9e8;
        }
        
        #mobileControls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 40px;
            box-sizing: border-box;
            z-index: 10;
        }
        
        .mobileBtn {
            width: 70px;
            height: 70px;
            background-color: rgba(255, 42, 109, 0.4);
            border: 2px solid #ff2a6d;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            user-select: none;
            position: relative;
            box-shadow: 0 0 15px #ff2a6d;
        }
        
        /* Preveniamo la selezione del testo */
        .mobileBtn {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Stili per i triangoli delle direzioni */
        #leftBtn::after, #rightBtn::after, #upBtn::after, #downBtn::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        #leftBtn::after {
            border-width: 15px 26px 15px 0;
            border-color: transparent #05d9e8 transparent transparent;
            left: 18px;
            filter: drop-shadow(0 0 5px #05d9e8);
        }
        
        #rightBtn::after {
            border-width: 15px 0 15px 26px;
            border-color: transparent transparent transparent #05d9e8;
            right: 18px;
            filter: drop-shadow(0 0 5px #05d9e8);
        }
        
        #upBtn::after {
            border-width: 0 15px 26px 15px;
            border-color: transparent transparent #05d9e8 transparent;
            top: 18px;
            filter: drop-shadow(0 0 5px #05d9e8);
        }
        
        #downBtn::after {
            border-width: 26px 15px 0 15px;
            border-color: #05d9e8 transparent transparent transparent;
            bottom: 18px;
            filter: drop-shadow(0 0 5px #05d9e8);
        }
        
        #musicToggle {
            display: none; /* Nascondiamo completamente il pulsante della musica */
        }
        
        #startScreen, #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #0c093c 0%, #2b0f54 40%, #530f77 70%, #ad52de 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 20;
            text-shadow: 0.1em 0.1em #333;
            overflow: hidden;
        }
        
        /* Griglia al suolo in stile retrowave */
        #startScreen::before, #gameOverScreen::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background-image: 
                linear-gradient(to bottom, rgba(5, 217, 232, 0.2) 1px, transparent 1px),
                linear-gradient(to right, rgba(5, 217, 232, 0.2) 1px, transparent 1px);
            background-size: 50px 25px;
            background-position: center;
            transform: perspective(300px) rotateX(60deg);
            transform-origin: bottom;
            z-index: -1;
        }
        
        /* Sole/luna in stile retrowave */
        #startScreen::after, #gameOverScreen::after {
            content: '';
            position: absolute;
            width: 150px;
            height: 150px;
            background: linear-gradient(to bottom, #ff2a6d, #ad52de);
            border-radius: 50%;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
            box-shadow: 0 0 100px 20px #ff2a6d;
        }
        
        .retro-text {
            text-transform: uppercase;
            letter-spacing: 3px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 48px;
            background-image: linear-gradient(to bottom, #05d9e8, #ad52de);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            -webkit-text-stroke: 2px #ff2a6d;
            text-shadow: 
                0 0 10px #05d9e8,
                0 0 20px #05d9e8,
                0 0 30px #05d9e8;
            margin-bottom: 30px;
            position: relative;
            animation: textPulse 2s infinite alternate;
        }
        
        @keyframes textPulse {
            0% {
                text-shadow: 
                    0 0 10px #05d9e8,
                    0 0 20px #05d9e8;
            }
            100% {
                text-shadow: 
                    0 0 15px #05d9e8,
                    0 0 25px #05d9e8,
                    0 0 35px #05d9e8;
            }
        }
        
        @keyframes scanlines {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 0 30px;
            }
        }
        
        .presents {
            font-size: 18px;
            color: #10BADA;
            margin-bottom: 5px;
            text-align: center;
            font-weight: bold;
            text-shadow: 0 0 10px #ff2a6d;
        }
        
        .btn {
            background-color: transparent;
            color: #05d9e8;
            border: 2px solid #05d9e8;
            padding: 12px 24px;
            margin-top: 30px;
            cursor: pointer;
            font-size: 18px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 0 15px #05d9e8;
            text-shadow: 0 0 10px #05d9e8;
            letter-spacing: 2px;
        }
        
        .btn:hover {
            background-color: rgba(5, 217, 232, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 25px #05d9e8;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        #gameOverScreen {
            display: none;
        }
        
        h1 {
            font-size: 42px;
            margin-bottom: 10px;
            position: relative;
            padding: 10px;
            z-index: 1;
        }
        
        p {
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
            padding: 0 20px;
            color: #fff;
            max-width: 80%;
            text-shadow: 0 0 5px #ad52de;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameInfo">
            LEVEL: <span id="levelDisplay">1</span> | LIVES: <span id="livesDisplay">3</span>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div id="mobileControls">
            <div class="mobileBtn" id="leftBtn"></div>
            <div class="mobileBtn" id="upBtn"></div>
            <div class="mobileBtn" id="downBtn"></div>
            <div class="mobileBtn" id="rightBtn"></div>
        </div>
        
        <div id="startScreen">
            <div class="presents">VINCENZO SALVIA PRESENTS</div>
            <h1 class="retro-text">PIZZA CROSSING</h1>
            <p>Deliver your pizza through the neon streets</p>
            <p>without getting hit by traffic!</p>
            <button class="btn" id="startBtn">PRESS START</button>
        </div>
        
        <div id="gameOverScreen">
            <h1 class="retro-text">GAME OVER</h1>
            <p>Pizza delivery failed!</p>
            <p>Your final level: <span id="finalLevel">1</span></p>
            <button class="btn" id="restartBtn">INSERT COIN</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Documento caricato, inizializzazione gioco...");
            
            // Variabili di gioco
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const levelDisplay = document.getElementById('levelDisplay');
            const livesDisplay = document.getElementById('livesDisplay');
            const finalLevelDisplay = document.getElementById('finalLevel');
            const startScreen = document.getElementById('startScreen');
            const gameOverScreen = document.getElementById('gameOverScreen');
            const startBtn = document.getElementById('startBtn');
            const restartBtn = document.getElementById('restartBtn');
        
        // Dimensioni del canvas
        canvas.width = 600;
        canvas.height = 800;
        
        // Constanti di gioco
        const ROAD_HEIGHT = 80;
        const SIDEWALK_HEIGHT = 100;
        const PLAYER_SIZE = 40;
        const CAR_WIDTH = 90; // Leggermente più larghe
        const CAR_HEIGHT = 40;
        
        // Stato di gioco
        let gameActive = false;
        let level = 1;
        let lives = 3;
        let playerX = canvas.width / 2 - PLAYER_SIZE / 2;
        let playerY = canvas.height - SIDEWALK_HEIGHT - PLAYER_SIZE / 2;
        let cars = [];
        let lastTime = 0;
        let crashed = false;
        let crashTime = 0;
        let pizzaX = 0;
        let pizzaY = 0;
        let sauceParticles = [];
        let homeY = SIDEWALK_HEIGHT / 2;
        
        // Colori
        const colors = {
            road: '#341677',
            roadLine: '#ff2a6d',
            sidewalk: '#530f77',
            player: '#ff2a6d',
            playerLeg: '#05d9e8',
            pizzaBox: '#ffffff',
            sauce: '#ff2a6d',
            car: ['#05d9e8', '#ff2a6d', '#ad52de', '#32f4ff', '#fe7eaf']
        };
        
        // Controlli
        const keys = {
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false
        };
        
        // Impostazioni iniziali - nessuna referenza all'audio
        function resetGame() {
            level = 1;
            lives = 5;
            levelDisplay.textContent = level;
            livesDisplay.textContent = lives;
            playerX = canvas.width / 2 - PLAYER_SIZE / 2;
            playerY = canvas.height - SIDEWALK_HEIGHT - PLAYER_SIZE / 2;
            cars = [];
            crashed = false;
            sauceParticles = [];
            generateCars();
        }
        
        // Generazione delle macchine
        function generateCars() {
            cars = [];
            const numRoads = Math.floor((canvas.height - 2 * SIDEWALK_HEIGHT) / ROAD_HEIGHT);
            
            for (let i = 0; i < numRoads; i++) {
                const roadY = SIDEWALK_HEIGHT + i * ROAD_HEIGHT;
                // Ridurre il numero di auto per rendere il gioco più facile
                const numCars = Math.min(1 + Math.floor(level / 3), 4);
                const direction = i % 2 === 0 ? 1 : -1;
                // Ridurre la velocità delle auto per rendere il gioco più facile
                const speed = (1 + Math.min(level * 0.3, 3)) * direction;
                
                for (let j = 0; j < numCars; j++) {
                    const carSpacing = canvas.width / numCars;
                    // Aggiungere un offset casuale per variare la posizione delle auto
                    const randomOffset = Math.random() * 0.5 * carSpacing;
                    let carX;
                    
                    if (direction === 1) {
                        carX = j * carSpacing - CAR_WIDTH + randomOffset;
                    } else {
                        carX = canvas.width - j * carSpacing - randomOffset;
                    }
                    
                    cars.push({
                        x: carX,
                        y: roadY + ROAD_HEIGHT / 2 - CAR_HEIGHT / 2,
                        width: CAR_WIDTH,
                        height: CAR_HEIGHT,
                        speed: speed,
                        color: colors.car[Math.floor(Math.random() * colors.car.length)]
                    });
                }
            }
        }
        
        // Aggiornamento del gioco
        function update(time) {
            if (!lastTime) {
                lastTime = time;
            }
            const deltaTime = (time - lastTime) / 1000;
            lastTime = time;
            
            if (!gameActive) {
                requestAnimationFrame(update);
                return;
            }
            
            if (!crashed) {
                // Movimento del giocatore
                const moveSpeed = 200;
                if (keys.ArrowUp && playerY > SIDEWALK_HEIGHT) {
                    playerY -= moveSpeed * deltaTime;
                }
                if (keys.ArrowDown && playerY < canvas.height - SIDEWALK_HEIGHT - PLAYER_SIZE) {
                    playerY += moveSpeed * deltaTime;
                }
                if (keys.ArrowLeft && playerX > 0) {
                    playerX -= moveSpeed * deltaTime;
                }
                if (keys.ArrowRight && playerX < canvas.width - PLAYER_SIZE) {
                    playerX += moveSpeed * deltaTime;
                }
                
                // Aggiornamento delle macchine
                cars.forEach(car => {
                    car.x += car.speed * deltaTime * 60;
                    
                    // Riposizionamento delle macchine che escono dallo schermo
                    if (car.speed > 0 && car.x > canvas.width) {
                        car.x = -car.width;
                    } else if (car.speed < 0 && car.x < -car.width) {
                        car.x = canvas.width;
                    }
                    
                    // Rilevamento collisioni
                    if (!crashed &&
                        playerX < car.x + car.width &&
                        playerX + PLAYER_SIZE > car.x &&
                        playerY < car.y + car.height &&
                        playerY + PLAYER_SIZE > car.y) {
                        crashed = true;
                        crashTime = time;
                        pizzaX = playerX;
                        pizzaY = playerY - 10;
                        
                        // Creazione delle particelle di sugo
                        for (let i = 0; i < 20; i++) {
                            sauceParticles.push({
                                x: pizzaX + PLAYER_SIZE / 2,
                                y: pizzaY + PLAYER_SIZE / 2,
                                vx: (Math.random() - 0.5) * 5,
                                vy: (Math.random() - 0.5) * 5,
                                size: Math.random() * 8 + 2
                            });
                        }
                        
                        lives--;
                        livesDisplay.textContent = lives;
                        
                        if (lives <= 0) {
                            setTimeout(() => {
                                gameActive = false;
                                finalLevelDisplay.textContent = level;
                                gameOverScreen.style.display = 'flex';
                            }, 2000);
                        } else {
                            // Riavvio dopo l'incidente
                            setTimeout(() => {
                                crashed = false;
                                playerX = canvas.width / 2 - PLAYER_SIZE / 2;
                                playerY = canvas.height - SIDEWALK_HEIGHT - PLAYER_SIZE / 2;
                                sauceParticles = [];
                            }, 2000);
                        }
                    }
                });
                
                // Verifica vittoria livello
                if (playerY <= SIDEWALK_HEIGHT) {
                    // Reset degli input per evitare movimento indesiderato al livello successivo
                    keys.ArrowUp = false;
                    keys.ArrowDown = false;
                    keys.ArrowLeft = false;
                    keys.ArrowRight = false;
                    
                    // Piccola pausa prima del prossimo livello
                    gameActive = false;
                    
                    // Variabile per effetto lampeggiante
                    let flash = true;
                    const flashInterval = setInterval(() => {
                        flash = !flash;
                    }, 300);
                    
                    // Funzione per disegnare il messaggio di livello superato
                    function drawLevelClearedMessage() {
                        // Overlay semitrasparente in stile retrowave
                        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                        gradient.addColorStop(0, "rgba(12, 9, 60, 0.9)");
                        gradient.addColorStop(1, "rgba(83, 15, 119, 0.9)");
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Griglia in prospettiva
                        ctx.strokeStyle = 'rgba(5, 217, 232, 0.4)';
                        ctx.lineWidth = 1;
                        
                        const gridSpacing = 30;
                        const vanishingPointY = canvas.height / 2;
                        
                        // Linee orizzontali
                        for (let y = canvas.height; y > 0; y -= gridSpacing) {
                            ctx.beginPath();
                            ctx.moveTo(0, y);
                            ctx.lineTo(canvas.width, y);
                            ctx.stroke();
                        }
                        
                        // Linee verticali
                        for (let x = 0; x <= canvas.width; x += gridSpacing) {
                            ctx.beginPath();
                            ctx.moveTo(x, 0);
                            ctx.lineTo(x, canvas.height);
                            ctx.stroke();
                        }
                        
                        // Prima riga - titolo principale
                        ctx.fillStyle = '#ff2a6d';
                        ctx.font = 'bold 36px "Courier New", monospace';
                        ctx.textAlign = 'center';
                        ctx.fillText(`LEVEL ${level} CLEARED!`, canvas.width/2, canvas.height/2 - 60);
                        
                        // Effetto bagliore intorno al testo
                        ctx.shadowColor = '#ff2a6d';
                        ctx.shadowBlur = 20;
                        ctx.fillText(`LEVEL ${level} CLEARED!`, canvas.width/2, canvas.height/2 - 60);
                        ctx.shadowBlur = 0;
                        
                        // Seconda riga - congratulazioni pizza
                        ctx.fillStyle = '#05d9e8';
                        ctx.font = 'bold 24px "Courier New", monospace';
                        ctx.shadowColor = '#05d9e8';
                        ctx.shadowBlur = 15;
                        ctx.fillText(`PIZZA SUCCESSFULLY DELIVERED!`, canvas.width/2, canvas.height/2);
                        ctx.shadowBlur = 0;
                        
                        // Terza riga - prossimo livello (lampeggiante)
                        if (flash) {
                            ctx.fillStyle = '#ad52de';
                            ctx.font = 'bold 20px "Courier New", monospace';
                            ctx.shadowColor = '#ad52de';
                            ctx.shadowBlur = 10;
                            ctx.fillText(`NEXT DELIVERY INCOMING...`, canvas.width/2, canvas.height/2 + 60);
                            ctx.shadowBlur = 0;
                        }
                        
                        // Se è ancora attivo, continua l'animazione
                        if (gameActive === false) {
                            requestAnimationFrame(drawLevelClearedMessage);
                        }
                    }
                    
                    // Avvia l'animazione
                    drawLevelClearedMessage();
                    
                    // Passa al prossimo livello dopo una breve pausa
                    setTimeout(() => {
                        clearInterval(flashInterval);
                        level++;
                        levelDisplay.textContent = level;
                        playerX = canvas.width / 2 - PLAYER_SIZE / 2;
                        playerY = canvas.height - SIDEWALK_HEIGHT - PLAYER_SIZE / 2;
                        generateCars();
                        gameActive = true;
                    }, 3000); // Aumentiamo il tempo a 3 secondi per leggere il messaggio
                }
            } else {
                // Aggiornamento animazione incidente
                sauceParticles.forEach(particle => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.size *= 0.99;
                });
            }
            
            draw();
            requestAnimationFrame(update);
        }
        
        // Disegno del gioco
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Sfondo retrowave
            drawRetrowaveBackground();
            
            // Disegno strada e marciapiedi
            ctx.fillStyle = colors.sidewalk;
            ctx.fillRect(0, 0, canvas.width, SIDEWALK_HEIGHT);
            ctx.fillRect(0, canvas.height - SIDEWALK_HEIGHT, canvas.width, SIDEWALK_HEIGHT);
            
            // Disegno casa
            drawHome();
            
            // Disegno strade
            const numRoads = Math.floor((canvas.height - 2 * SIDEWALK_HEIGHT) / ROAD_HEIGHT);
            ctx.fillStyle = colors.road;
            
            for (let i = 0; i < numRoads; i++) {
                const roadY = SIDEWALK_HEIGHT + i * ROAD_HEIGHT;
                ctx.fillRect(0, roadY, canvas.width, ROAD_HEIGHT);
                
                // Linee di mezzeria
                ctx.strokeStyle = colors.roadLine;
                ctx.setLineDash([20, 10]);
                ctx.beginPath();
                ctx.moveTo(0, roadY + ROAD_HEIGHT / 2);
                ctx.lineTo(canvas.width, roadY + ROAD_HEIGHT / 2);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Disegno macchine
            cars.forEach(car => {
                drawCar(car);
            });
            
            // Disegno giocatore
            if (!crashed) {
                drawPlayer(playerX, playerY);
            } else {
                // Animazione caduta
                drawFallenPlayer(playerX, playerY);
                
                // Disegno cartone pizza caduta
                ctx.fillStyle = colors.pizzaBox;
                ctx.fillRect(pizzaX, pizzaY, 25, 25);
                // Aggiunta di un po' di dettaglio al cartone
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 1;
                ctx.strokeRect(pizzaX, pizzaY, 25, 25);
                // Linea del logo sulla scatola
                ctx.strokeStyle = colors.player;
                ctx.beginPath();
                ctx.moveTo(pizzaX + 5, pizzaY + 12);
                ctx.lineTo(pizzaX + 20, pizzaY + 12);
                ctx.stroke();
                
                // Disegno particelle sugo
                ctx.fillStyle = colors.sauce;
                sauceParticles.forEach(particle => {
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
            
            // Effetto CRT
            drawCRTEffect();
        }
        
        // Sfondo retrowave
        function drawRetrowaveBackground() {
            // Cielo sfumato
            const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            skyGradient.addColorStop(0, "#0c093c");
            skyGradient.addColorStop(0.4, "#2b0f54");
            skyGradient.addColorStop(0.7, "#530f77");
            skyGradient.addColorStop(1, "#ad52de");
            
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Sole/luna retrowave
            ctx.fillStyle = "#ff2a6d";
            ctx.beginPath();
            ctx.arc(canvas.width / 2, 120, 60, 0, Math.PI * 2);
            ctx.fill();
            
            // Bagliore intorno al sole
            const sunGlow = ctx.createRadialGradient(
                canvas.width / 2, 120, 60,
                canvas.width / 2, 120, 120
            );
            sunGlow.addColorStop(0, "rgba(255, 42, 109, 0.8)");
            sunGlow.addColorStop(1, "rgba(255, 42, 109, 0)");
            
            ctx.fillStyle = sunGlow;
            ctx.beginPath();
            ctx.arc(canvas.width / 2, 120, 120, 0, Math.PI * 2);
            ctx.fill();
            
            // Griglia prospettica (stile "Tron grid")
            ctx.strokeStyle = "rgba(5, 217, 232, 0.7)";
            ctx.lineWidth = 1;
            
            // Linee orizzontali della griglia
            const gridSpacing = 40;
            for (let y = canvas.height; y > canvas.height / 2; y -= gridSpacing) {
                const lineWidth = 2 * ((y - canvas.height / 2) / (canvas.height / 2));
                
                ctx.lineWidth = lineWidth;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Linee verticali che convergono nel punto di fuga
            const vanishingPointX = canvas.width / 2;
            const vanishingPointY = canvas.height / 3;
            const numVerticals = 12;
            
            for (let i = 0; i <= numVerticals; i++) {
                const x = (i / numVerticals) * canvas.width;
                const lineWidth = 2 * Math.abs((x - vanishingPointX) / (canvas.width / 2));
                
                ctx.lineWidth = lineWidth;
                ctx.beginPath();
                ctx.moveTo(x, canvas.height);
                ctx.lineTo(vanishingPointX + (x - vanishingPointX) * 0.5, vanishingPointY + canvas.height / 4);
                ctx.stroke();
            }
        }
        
        // Effetto CRT per dare un aspetto più retro
        function drawCRTEffect() {
            // Leggero effetto scanline
            ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
            for (let i = 0; i < canvas.height; i += 4) {
                ctx.fillRect(0, i, canvas.width, 2);
            }
            
            // Leggero effetto vignetta ai bordi
            const gradient = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, canvas.height / 3,
                canvas.width / 2, canvas.height / 2, canvas.height
            );
            gradient.addColorStop(0, "rgba(0, 0, 0, 0)");
            gradient.addColorStop(1, "rgba(0, 0, 0, 0.7)");
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // Disegno casa (destinazione migliorata)
        function drawHome() {
            // Ombra della casa
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.beginPath();
            ctx.ellipse(canvas.width / 2, homeY + 42, 70, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Base della casa
            ctx.fillStyle = '#ecf0f1';
            ctx.beginPath();
            ctx.roundRect(canvas.width / 2 - 50, homeY - 15, 100, 55, 5);
            ctx.fill();
            
            // Tetto
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 60, homeY - 15); // Angolo sinistro
            ctx.lineTo(canvas.width / 2, homeY - 55);      // Punta del tetto
            ctx.lineTo(canvas.width / 2 + 60, homeY - 15); // Angolo destro
            ctx.closePath();
            ctx.fill();
            
            // Dettagli sul tetto
            ctx.fillStyle = '#c0392b'; // Colore più scuro
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 10, homeY - 22);
            ctx.lineTo(canvas.width / 2, homeY - 35);
            ctx.lineTo(canvas.width / 2 + 10, homeY - 22);
            ctx.closePath();
            ctx.fill();
            
            // Finestre con riflesso
            ctx.fillStyle = '#3498db'; // Blu finestra
            
            // Finestra sinistra
            ctx.beginPath();
            ctx.roundRect(canvas.width / 2 - 35, homeY - 5, 20, 20, 3);
            ctx.fill();
            
            // Finestra destra
            ctx.beginPath();
            ctx.roundRect(canvas.width / 2 + 15, homeY - 5, 20, 20, 3);
            ctx.fill();
            
            // Riflessi sulle finestre (effetto lucido)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            
            // Riflesso finestra sinistra
            ctx.beginPath();
            ctx.roundRect(canvas.width / 2 - 32, homeY - 2, 14, 5, 2);
            ctx.fill();
            
            // Riflesso finestra destra
            ctx.beginPath();
            ctx.roundRect(canvas.width / 2 + 18, homeY - 2, 14, 5, 2);
            ctx.fill();
            
            // Porta con maniglia
            ctx.fillStyle = '#34495e';
            ctx.beginPath();
            ctx.roundRect(canvas.width / 2 - 15, homeY + 5, 30, 35, [0, 0, 5, 5]);
            ctx.fill();
            
            // Maniglia della porta
            ctx.fillStyle = '#f1c40f';
            ctx.beginPath();
            ctx.arc(canvas.width / 2 + 5, homeY + 20, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Vialetto
            ctx.fillStyle = '#95a5a6';
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 20, homeY + 40);
            ctx.lineTo(canvas.width / 2 + 20, homeY + 40);
            ctx.lineTo(canvas.width / 2 + 15, homeY + 60);
            ctx.lineTo(canvas.width / 2 - 15, homeY + 60);
            ctx.closePath();
            ctx.fill();
            
            // Comignolo
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(canvas.width / 2 + 30, homeY - 45, 10, 20);
            
            // Fumo dal comignolo (animato)
            const now = Date.now();
            for (let i = 0; i < 3; i++) {
                const offset = Math.sin(now / 500 + i) * 5;
                const smokeY = homeY - 50 - i * 10;
                const smokeSize = 7 - i * 1.5;
                
                ctx.fillStyle = 'rgba(200, 200, 200, ' + (0.7 - i * 0.2) + ')';
                ctx.beginPath();
                ctx.arc(canvas.width / 2 + 35 + offset, smokeY, smokeSize, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // Disegno giocatore di spalle (stile low poly ma carino)
        function drawPlayer(x, y) {
            // Ombra sotto il giocatore
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.beginPath();
            ctx.ellipse(x + PLAYER_SIZE/2, y + PLAYER_SIZE + 2, PLAYER_SIZE * 0.4, PLAYER_SIZE * 0.1, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Gambe
            ctx.fillStyle = '#34495e'; // Jeans scuri
            
            // Gamba sinistra
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE * 0.2, y + PLAYER_SIZE * 0.6, PLAYER_SIZE * 0.2, PLAYER_SIZE * 0.5, 3);
            ctx.fill();
            
            // Gamba destra
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE * 0.6, y + PLAYER_SIZE * 0.6, PLAYER_SIZE * 0.2, PLAYER_SIZE * 0.5, 3);
            ctx.fill();
            
            // Corpo/divisa (di spalle)
            ctx.fillStyle = '#e74c3c'; // Rosso divisa
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE * 0.15, y + PLAYER_SIZE * 0.25, PLAYER_SIZE * 0.7, PLAYER_SIZE * 0.4, 5);
            ctx.fill();
            
            // Scritta "PIZZA" sulla schiena
            ctx.fillStyle = '#f1c40f'; // Giallo scritta
            ctx.font = 'bold 9px Arial';
            ctx.textAlign = 'center';
            ctx.fillText("PIZZA", x + PLAYER_SIZE * 0.5, y + PLAYER_SIZE * 0.45);
            
            // Braccia
            ctx.fillStyle = '#e74c3c'; // Rosso divisa
            
            // Braccio sinistro
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE * 0.05, y + PLAYER_SIZE * 0.3, PLAYER_SIZE * 0.15, PLAYER_SIZE * 0.3, 3);
            ctx.fill();
            
            // Braccio destro (regge la pizza)
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE * 0.8, y + PLAYER_SIZE * 0.3, PLAYER_SIZE * 0.15, PLAYER_SIZE * 0.3, 3);
            ctx.fill();
            
            // Testa (di spalle, si vede solo i capelli)
            ctx.fillStyle = '#6c3207'; // Marrone capelli
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE * 0.5, y + PLAYER_SIZE * 0.15, PLAYER_SIZE * 0.25, 0, Math.PI * 2);
            ctx.fill();
            
            // Orecchie
            ctx.fillStyle = '#f5d0a9'; // Colore pelle
            
            // Orecchio sinistro
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE * 0.3, y + PLAYER_SIZE * 0.15, PLAYER_SIZE * 0.08, 0, Math.PI * 2);
            ctx.fill();
            
            // Orecchio destro
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE * 0.7, y + PLAYER_SIZE * 0.15, PLAYER_SIZE * 0.08, 0, Math.PI * 2);
            ctx.fill();
            
            // Capelli dettagliati
            ctx.fillStyle = '#4e2706'; // Marrone capelli più scuro per ombreggiature
            
            // Ciuffo superiore
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE * 0.5, y + PLAYER_SIZE * 0.05, PLAYER_SIZE * 0.15, 0, Math.PI, true);
            ctx.fill();
            
            // Ciuffo laterale sinistro
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE * 0.35, y + PLAYER_SIZE * 0.1, PLAYER_SIZE * 0.1, Math.PI * 1.5, Math.PI * 0.5, true);
            ctx.fill();
            
            // Ciuffo laterale destro
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE * 0.65, y + PLAYER_SIZE * 0.1, PLAYER_SIZE * 0.1, Math.PI * 0.5, Math.PI * 1.5, true);
            ctx.fill();
            
            // Cartone della pizza (migliorato)
            ctx.fillStyle = colors.pizzaBox;
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE - 5, y - 5, 30, 30, 3);
            ctx.fill();
            
            // Bordo del cartone
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE - 5, y - 5, 30, 30, 3);
            ctx.stroke();
            
            // Logo pizzeria sul cartone
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE + 10, y + 10, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Dettagli logo (fetta di pizza stilizzata)
            ctx.fillStyle = '#f1c40f';
            ctx.beginPath();
            ctx.moveTo(x + PLAYER_SIZE + 10, y + 10);
            ctx.lineTo(x + PLAYER_SIZE + 15, y + 5);
            ctx.lineTo(x + PLAYER_SIZE + 15, y + 15);
            ctx.closePath();
            ctx.fill();
        }
        
        // Disegno giocatore caduto
        function drawFallenPlayer(x, y) {
            // Ombra sotto il giocatore caduto
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.beginPath();
            ctx.ellipse(x + PLAYER_SIZE/2, y + PLAYER_SIZE + 2, PLAYER_SIZE * 0.5, PLAYER_SIZE * 0.1, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Corpo caduto
            ctx.fillStyle = '#e74c3c'; // Rosso divisa
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE * 0.15, y + PLAYER_SIZE * 0.4, PLAYER_SIZE * 0.7, PLAYER_SIZE * 0.4, 5);
            ctx.fill();
            
            // Gambe cadute
            ctx.fillStyle = '#34495e'; // Jeans scuri
            
            // Gamba sinistra
            ctx.beginPath();
            ctx.roundRect(x, y + PLAYER_SIZE * 0.7, PLAYER_SIZE * 0.3, PLAYER_SIZE * 0.2, 3);
            ctx.fill();
            
            // Gamba destra
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE * 0.4, y + PLAYER_SIZE * 0.7, PLAYER_SIZE * 0.3, PLAYER_SIZE * 0.2, 3);
            ctx.fill();
            
            // Braccia cadute
            ctx.fillStyle = '#e74c3c'; // Rosso divisa
            
            // Braccio sinistro
            ctx.beginPath();
            ctx.roundRect(x + PLAYER_SIZE * 0.8, y + PLAYER_SIZE * 0.45, PLAYER_SIZE * 0.3, PLAYER_SIZE * 0.15, 3);
            ctx.fill();
            
            // Braccio destro
            ctx.beginPath();
            ctx.roundRect(x - PLAYER_SIZE * 0.1, y + PLAYER_SIZE * 0.45, PLAYER_SIZE * 0.3, PLAYER_SIZE * 0.15, 3);
            ctx.fill();
            
            // Testa caduta e inclinata
            ctx.fillStyle = '#f5d0a9'; // Colore pelle
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE * 0.25, y + PLAYER_SIZE * 0.3, PLAYER_SIZE * 0.25, 0, Math.PI * 2);
            ctx.fill();
            
            // Capelli
            ctx.fillStyle = '#6c3207'; // Marrone capelli
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE * 0.3, y + PLAYER_SIZE * 0.2, PLAYER_SIZE * 0.2, Math.PI, 0, true);
            ctx.closePath();
            ctx.fill();
            
            // Occhi a X (stordito)
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 2;
            
            // X occhio sinistro
            ctx.beginPath();
            ctx.moveTo(x + PLAYER_SIZE * 0.15, y + PLAYER_SIZE * 0.25);
            ctx.lineTo(x + PLAYER_SIZE * 0.25, y + PLAYER_SIZE * 0.35);
            ctx.moveTo(x + PLAYER_SIZE * 0.25, y + PLAYER_SIZE * 0.25);
            ctx.lineTo(x + PLAYER_SIZE * 0.15, y + PLAYER_SIZE * 0.35);
            ctx.stroke();
            
            // X occhio destro
            ctx.beginPath();
            ctx.moveTo(x + PLAYER_SIZE * 0.3, y + PLAYER_SIZE * 0.25);
            ctx.lineTo(x + PLAYER_SIZE * 0.4, y + PLAYER_SIZE * 0.35);
            ctx.moveTo(x + PLAYER_SIZE * 0.4, y + PLAYER_SIZE * 0.25);
            ctx.lineTo(x + PLAYER_SIZE * 0.3, y + PLAYER_SIZE * 0.35);
            ctx.stroke();
            
            // Bocca storta
            ctx.beginPath();
            ctx.arc(x + PLAYER_SIZE * 0.3, y + PLAYER_SIZE * 0.4, PLAYER_SIZE * 0.1, 0, Math.PI, false);
            ctx.stroke();
            
            // Stelle che girano intorno alla testa (effetto stordito)
            const now = Date.now();
            for (let i = 0; i < 3; i++) {
                const angle = (now / 500) + (i * Math.PI * 2 / 3);
                const starX = x + PLAYER_SIZE * 0.25 + Math.cos(angle) * PLAYER_SIZE * 0.4;
                const starY = y + PLAYER_SIZE * 0.3 + Math.sin(angle) * PLAYER_SIZE * 0.3;
                
                ctx.fillStyle = '#f1c40f';
                drawStar(starX, starY, 5, PLAYER_SIZE * 0.08, PLAYER_SIZE * 0.04);
            }
        }
        
        // Funzione di supporto per disegnare una stella
        function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx;
            let y = cy;
            let step = Math.PI / spikes;
            
            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;
                
                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
            }
            
            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();
            ctx.fill();
        }
        
        // Disegno auto (stile low poly ma più carine)
        function drawCar(car) {
            const direction = car.speed > 0 ? 1 : -1; // 1 = va a destra, -1 = va a sinistra
            
            // Ombra leggera sotto l'auto
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.beginPath();
            ctx.ellipse(car.x + car.width/2, car.y + car.height + 2, car.width * 0.4, car.width * 0.1, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Corpo auto (base)
            ctx.fillStyle = car.color;
            ctx.beginPath();
            ctx.roundRect(car.x, car.y, car.width, car.height, 10);
            ctx.fill();
            
            // Carrozzeria superiore (tetto)
            ctx.fillStyle = car.color;
            const roofHeight = car.height * 0.6;
            const roofY = car.y - roofHeight * 0.3;
            const roofPadding = car.width * 0.15;
            
            ctx.beginPath();
            ctx.roundRect(
                car.x + roofPadding, 
                roofY, 
                car.width - roofPadding * 2, 
                roofHeight, 
                8
            );
            ctx.fill();
            
            // Finestrini
            ctx.fillStyle = '#d0f0ff'; // Azzurro chiaro
            const windowPadding = car.width * 0.05;
            ctx.beginPath();
            ctx.roundRect(
                car.x + roofPadding + windowPadding,
                roofY + windowPadding,
                car.width - (roofPadding + windowPadding) * 2,
                roofHeight - windowPadding * 2,
                5
            );
            ctx.fill();
            
            // Divisiore finestrini
            ctx.fillStyle = car.color;
            ctx.fillRect(
                car.x + car.width/2 - 2,
                roofY + windowPadding,
                4,
                roofHeight - windowPadding * 2
            );
            
            // Fari anteriori o posteriori a seconda della direzione
            const lightSize = car.width * 0.1;
            
            // Fari anteriori (gialli)
            ctx.fillStyle = '#ffee00';
            if (direction > 0) { // Auto che va verso destra
                // Faro anteriore destro
                ctx.beginPath();
                ctx.roundRect(
                    car.x + car.width - lightSize - 2,
                    car.y + car.height * 0.2,
                    lightSize,
                    lightSize,
                    3
                );
                ctx.fill();
            } else { // Auto che va verso sinistra
                // Faro anteriore sinistro
                ctx.beginPath();
                ctx.roundRect(
                    car.x + 2,
                    car.y + car.height * 0.2,
                    lightSize,
                    lightSize,
                    3
                );
                ctx.fill();
            }
            
            // Fari posteriori (rossi)
            ctx.fillStyle = '#ff3333';
            if (direction > 0) { // Auto che va verso destra
                // Faro posteriore sinistro
                ctx.beginPath();
                ctx.roundRect(
                    car.x + 2,
                    car.y + car.height * 0.2,
                    lightSize,
                    lightSize,
                    3
                );
                ctx.fill();
            } else { // Auto che va verso sinistra
                // Faro posteriore destro
                ctx.beginPath();
                ctx.roundRect(
                    car.x + car.width - lightSize - 2,
                    car.y + car.height * 0.2,
                    lightSize,
                    lightSize,
                    3
                );
                ctx.fill();
            }
            
            // Ruote (ora rotonde)
            ctx.fillStyle = '#222';
            
            // Ruota anteriore
            const wheelRadius = car.height * 0.25;
            const wheelY = car.y + car.height - wheelRadius / 2;
            
            // Ruota posteriore
            ctx.beginPath();
            ctx.arc(
                car.x + car.width * 0.25,
                wheelY,
                wheelRadius,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // Ruota anteriore
            ctx.beginPath();
            ctx.arc(
                car.x + car.width * 0.75,
                wheelY,
                wheelRadius,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // Cerchioni
            ctx.fillStyle = '#f0f0f0';
            
            // Cerchione posteriore
            ctx.beginPath();
            ctx.arc(
                car.x + car.width * 0.25,
                wheelY,
                wheelRadius * 0.5,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // Cerchione anteriore
            ctx.beginPath();
            ctx.arc(
                car.x + car.width * 0.75,
                wheelY,
                wheelRadius * 0.5,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // Griglia frontale
            if (direction > 0) { // Auto che va verso destra
                ctx.fillStyle = '#444';
                ctx.fillRect(
                    car.x + car.width - 8,
                    car.y + car.height * 0.6,
                    6,
                    car.height * 0.2
                );
            } else { // Auto che va verso sinistra
                ctx.fillStyle = '#444';
                ctx.fillRect(
                    car.x + 2,
                    car.y + car.height * 0.6,
                    6,
                    car.height * 0.2
                );
            }
        }
        
        // Gestione input tastiera
        window.addEventListener('keydown', e => {
            if (e.key in keys) {
                keys[e.key] = true;
                e.preventDefault();
            }
        });
        
        window.addEventListener('keyup', e => {
            if (e.key in keys) {
                keys[e.key] = false;
                e.preventDefault();
            }
        });
        
        // Controlli touch per mobile
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        
        upBtn.addEventListener('touchstart', () => { keys.ArrowUp = true; });
        upBtn.addEventListener('touchend', () => { keys.ArrowUp = false; });
        downBtn.addEventListener('touchstart', () => { keys.ArrowDown = true; });
        downBtn.addEventListener('touchend', () => { keys.ArrowDown = false; });
        leftBtn.addEventListener('touchstart', () => { keys.ArrowLeft = true; });
        leftBtn.addEventListener('touchend', () => { keys.ArrowLeft = false; });
        rightBtn.addEventListener('touchstart', () => { keys.ArrowRight = true; });
        rightBtn.addEventListener('touchend', () => { keys.ArrowRight = false; });
        
        // Per il supporto click su desktop
        upBtn.addEventListener('mousedown', () => { keys.ArrowUp = true; });
        upBtn.addEventListener('mouseup', () => { keys.ArrowUp = false; });
        downBtn.addEventListener('mousedown', () => { keys.ArrowDown = true; });
        downBtn.addEventListener('mouseup', () => { keys.ArrowDown = false; });
        leftBtn.addEventListener('mousedown', () => { keys.ArrowLeft = true; });
        leftBtn.addEventListener('mouseup', () => { keys.ArrowLeft = false; });
        rightBtn.addEventListener('mousedown', () => { keys.ArrowRight = true; });
        rightBtn.addEventListener('mouseup', () => { keys.ArrowRight = false; });
        
        // Redimensionamento canvas 
        function resizeCanvas() {
            const container = document.getElementById('gameContainer');
            const maxWidth = Math.min(window.innerWidth - 20, 600);
            container.style.width = maxWidth + 'px';
            
            // Proporzioni del canvas
            const aspectRatio = canvas.height / canvas.width;
            canvas.style.height = (maxWidth * aspectRatio) + 'px';
        }
        
        window.addEventListener('resize', resizeCanvas);
        
        // Pulsanti di controllo del gioco
        startBtn.addEventListener('click', () => {
            startScreen.style.display = 'none';
            resetGame();
            gameActive = true;
            
            // NON avviamo più la musica automaticamente
        });
        
        restartBtn.addEventListener('click', () => {
            gameOverScreen.style.display = 'none';
            resetGame();
            gameActive = true;
            
            // NON avviamo più la musica automaticamente
        });
        
        // Inizializzazione
        resizeCanvas();
        resetGame();
        requestAnimationFrame(update);
        
        });
    </script>
</body>
</html>
